var gt=Object.defineProperty;var yt=(n,t,e)=>t in n?gt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var x=(n,t,e)=>(yt(n,typeof t!="symbol"?t+"":t,e),e);function C(n){return n.length}function Mt(n){throw new Error(n)}function _(n){return Promise.resolve().then(n)}function y(n,t,e=0){for(;e<C(n);)t(n[e],e),e++}function R(n){return typeof n=="string"}function b(n){return typeof n=="object"&&n!==null}function xt(n){return Array.isArray(n)}function U(n){return typeof n=="function"}function kt(n){return n.toString().slice(0,5)==="class"}function H(n){return typeof n=="object"&&n[Symbol.toStringTag]==="Promise"}function bt(n){return n instanceof RegExp}function E(n,t){const e=new WeakSet;function s(o,i){if(b(o)&&b(i)){if(e.has(o)||e.has(i))return!0;e.add(o),e.add(i);const r=Object.keys(o),c=Object.keys(i);if(C(r)!==C(c))return!1;for(const a of r)if(!c.includes(a)||!s(o[a],i[a]))return!1;return!0}else return o===i}return s(n,t)}function F(n){return[null,void 0,!1].includes(n)}function B(){return typeof window=="object"}function Et(){return Number((Math.random()+"").slice(2)).toString(32)}function rt(n,t,e){if(typeof t=="string"&&(t=t.split(".")),t.length>1){const s=t.shift();n[s]=n[s]||{},rt(n[s],t,e)}else n[t[0]]=e}function L(n,t={},...e){t||(t={});const s={tag:n,attrs:t,children:(t.children||e).filter(o=>!F(o))};return W(n)&&!C(s.children)&&s.children.push(""),s}function V(){}function W(n){return n===V}function k(n){return b(n)&&b(n.attrs)}function P(n){return!W(n.tag)&&U(n.tag)}function J(n){const{tag:t,attrs:e,children:s}=n,o={...e,children:s};let i=t;if(kt(t)){const c=new t(o);i=c.render.bind(c)}let r=i(o);return P(r)?J(r):r}var $;(function(n){n.create="create",n.update="update",n.remove="remove"})($||($={}));function Z(n,t){const e=[],s=r=>Object.keys(r),o=s(n),i=s(t);for(const r of o){let p=function(m,h,u=""){if(k(m)&&k(h)){if(P(m)&&E(m,h))return rt(n,u,h),!0;u+=".children",y(m.children,(f,d)=>{const g=h.children[d];p(f,g,`${u}.${d}`)})}else return E(m,h)};const c=n[r],a=t[r],l={key:r,newValue:c,oldValue:a};if(!i.includes(r)){e.push({type:$.create,...l});continue}p(c,a,r)||(e.push({type:$.update,...l}),!b(c)&&!U(c)&&(t[r]=c))}for(const r of i)o.includes(r)||e.push({type:$.remove,key:r,newValue:n[r],oldValue:t[r]});return e}function ct(...n){const t=[];return y(n,e=>{U(e)&&(e=e()),F(e)||t.push(e)}),t.join(" ").trim().replace(/\s+/," ")}function tt(n,t){y(t,(e,s)=>{const o=n[s];o?e.replaceWith(o):e.remove()}),y(n,(e,s)=>{n[s-1].after(e)},C(t))}function wt(n,t){t.after(...n)}function O(n){y(n,t=>{t.remove()})}function et(n,t,e){if(t==="style"&&b(e)){for(const s in e)n[t][s]=e[s];return}t==="className"&&xt(e)&&(e=ct(...e)),n[t]=e}const Ct=new Map;function nt(n){for(const t of Ct.values()){const e=t.get(n.attrs.key||n.tag);if(e)return e}}class N{constructor(){x(this,"instance");x(this,"count");x(this,"dataMap",new WeakMap)}setInstance(t){this.count=0,this.instance=t}fixInstance(t,e){const s=this.dataMap.get(e);s&&(this.dataMap.set(t,s),this.dataMap.delete(e))}removeInstance(t){this.dataMap.delete(t)}}function v(n){n||Mt("Please set the instance first")}class Rt extends N{constructor(e){super();x(this,"option");this.option=e}use(e){const{instance:s,dataMap:o,count:i,option:r}=this;v(s);const c=o.get(s)||new Map;let a;c.has(i)||c.set(i,U(e)?e():e),a=c.get(i);const l=p=>{const m=c.get(i);if(p=U(p)?p(m):p,E(p,m))return;c.set(i,p);const{update:h}=r;h(s)};return o.set(s,c),this.count++,[a,l]}}class Nt extends N{use(t,e){const{instance:s,dataMap:o,count:i}=this;v(s);const r=o.get(s)||new Map,c=r.get(i);if(c&&e!==void 0&&E(e,c.deps))return this.count++,c.result;const a=t();return r.set(i,{result:a,deps:e}),o.set(s,r),this.count++,a}}class vt extends N{use(t,e){const{instance:s,dataMap:o,count:i}=this;v(s);const r=o.get(s)||new Map,c=r.get(i);return c&&e!==void 0&&E(e,c.deps)?c.func:(r.set(i,{func:t,deps:e}),this.count++,t)}}class st extends N{use(t,e){const{instance:s,dataMap:o,count:i}=this;v(s);const r=o.get(s)||new Map,c=r.get(i);r.set(i,{func:t,deps:e,oldDeps:c==null?void 0:c.oldDeps,clear:c==null?void 0:c.clear}),o.set(s,r),this.count++}run(t){const e=this.dataMap.get(t);e&&e.forEach(async s=>{const{clear:o,func:i,deps:r,oldDeps:c}=s;if(r!==void 0&&E(r,c))return;o&&o();const a=i();s.clear=H(a)?await a:a,s.oldDeps=r})}runClear(t){const e=this.dataMap.get(t);e&&e.forEach(s=>{s.clear&&s.clear()})}}class St extends N{use(t){const{instance:e,dataMap:s,count:o}=this;v(e);const i=s.get(e)||new Map;let r=i.get(o);return r||(r={current:t},i.set(o,r),s.set(e,i)),this.count++,r}}class $t extends N{use(t,e,s){const{instance:o,dataMap:i,count:r}=this;if(v(o),!t)return;const c=i.get(o)||new Map,a=c.get(r);if(!a||a.deps===void 0||!E(a.deps,s)){const l=e();t.current=l,c.set(r,{expose:l,deps:s}),i.set(o,c)}else t.current=a.expose;this.count++}}class It extends N{constructor(){super();x(this,"ctx");const e=this.fixInstance;this.fixInstance=(s,o)=>{this.ctx&&this.ctx.replace(s,o),e.call(this,s,o)}}use(e){const{instance:s}=this;return v(s),this.ctx=e,e.append(s),e.inject()}}class it extends N{constructor(e){super();x(this,"option");this.option=e}use(e,s,o){const{instance:i,dataMap:r,count:c,option:a}=this;v(i);const l=r.get(i)||new Map;if(l.has(c)){const m=l.get(c);return this.count++,[m.state,m.dispatch]}s=o?o(s):s;async function p(m){s=await e(s,m),l.set(c,{state:s,dispatch:p}),a.update(i)}return l.set(c,{state:s,dispatch:p}),r.set(i,l),this.count++,[s,p]}}const D=new Map;function Kt(n,t,e){const s={id:Math.random()};function o(){D.get(s).forEach(r=>{Q().compUpdate(r)})}const i=new it({update:o});return i.setInstance(s),{reducer:i,handle:n,state:t,init:e,key:s}}class Ut extends N{use(t){const{instance:e}=this;v(e);const{reducer:s,handle:o,state:i,init:r,key:c}=t,a=D.get(c);a?a.add(e):D.set(c,new Set([e])),s.count=0;const[l,p]=s.use(o,i,r);return{state:l,dispatch:p}}remove(t){D.forEach(e=>{e.delete(t)})}}class jt{constructor(t={}){x(this,"option");x(this,"fragmentMap",new Map);x(this,"treeMap",new WeakMap);this.option=t}render(t){const{intercept:e}=this.option;if(e==null||e(t),!b(t))return[document.createTextNode(t)];const{tag:s}=t;return R(s)?[this.toReals(t)]:W(s)?this.toFragment(t):this.createComp(t)}toReals(t){const{nodeMount:e}=this.option,{tag:s,attrs:o,children:i}=t,r=document.createElement(s);for(const c in o)et(r,c,o[c]);return y(i,c=>{const a=this.render(c);r.append(...a)}),e==null||e(t,r),r}toFragment(t){const e=[];return y(t.children,s=>{const o=this.render(s);e.push(...o)}),this.fragmentMap.set(t,e),e}replaceTreeMap(t,e){var o,i;(i=(o=this.option).compTreeReplace)==null||i.call(o,t,e);const s=this.treeMap.get(e);this.treeMap.set(t,s),this.treeMap.delete(e)}compTreeExec(t){const{currentCompTree:e,created:s}=this.option;e==null||e(t);const o=J(t);return s==null||s(t,o),o}createComp(t){var i,r;const e=nt(t);if(e)return this.treeMap.set(t,e),e.nodes;const s=this.compTreeExec(t),o=this.render(s);return this.treeMap.set(t,{tree:s,nodes:o}),(r=(i=this.option).mount)==null||r.call(i,t,s,o),o}destroyComp(t,e=!0){var s,o;if(k(t))if(P(t)){const i=nt(t),r=this.treeMap.get(t),{tree:c,nodes:a}=r;if(i){e&&O(a);return}this.destroyComp(c),(o=(s=this.option).unmount)==null||o.call(s,t,a),e&&O(a),this.treeMap.delete(t)}else y(t.children,i=>{this.destroyComp(i)})}updateComp(t){const e=this.treeMap.get(t);if(!e)return;const s=this.compTreeExec(t);this.updateTree(s,e.tree,e.nodes),e.tree=s;const{mount:o}=this.option;return o&&o(t,s,e.nodes),s}updateTree(t,e,s){const o=this;if(k(t)&&k(e)){if(t.tag!==e.tag){o.destroyComp(e,!1);const r=o.render(t);return tt(r,s),r}if(W(t.tag)){const r=o.fragmentMap.get(e)||s,c=[];return y(t.children,(a,l)=>{const p=e.children[l],m=r[l];if(E(a,p)){c.push(m);return}let h=[];if(F(p)){h=o.render(a);const u=c[l-1];wt(h,u)}else{const u=o.updateTree(a,p,[m]);h.push(...u)}c.push(...h)}),y(r,a=>{a.remove()},C(t.children)),o.fragmentMap.set(t,c),o.fragmentMap.delete(e),c}if(R(t.tag)){const r=s[0],{nodeUpdate:c}=o.option;c&&c(t,e,r);const a=Z(t.attrs,e.attrs);y(a,m=>{const{type:h,key:u}=m;let f=m.newValue;h===$.remove?r.removeAttribute(u==="className"?"class":u):et(r,u,f)});const l=Z(t.children,e.children),p=[];return y(l,m=>{const{type:h,key:u,newValue:f,oldValue:d}=m,g=r.childNodes[u];if(h===$.remove)k(d)&&P(d)?o.destroyComp(d):p.push(g);else if(h===$.create){const M=o.render(f);r.append(...M)}else{let M=[g];k(d)&&(P(d)?M=o.treeMap.get(d).nodes:W(d.tag)&&(M=r.childNodes)),o.updateTree(f,d,M)}}),y(p,m=>m.remove()),s}if(P(t)){o.replaceTreeMap(t,e);const r=o.treeMap.get(t),c=o.compTreeExec(t),a=o.updateTree(c,r.tree,s);r.tree=c;const{mount:l}=this.option;return l&&l(t,c,a),a}}if(t||o.destroyComp(e,!1),F(t))return O(s),[];const i=o.render(t);return tt(i,s),i}}function Pt(n,t={}){const{intercept:e,currentCompTree:s}=t;function o(a){if(e==null||e(a),!k(a))return a;const{tag:l}=a;return R(l)?i(a):W(l)?r(a.children):c(a)}function i(a){const{tag:l,attrs:p,children:m}=a;let h="";for(const u in p){let f=p[u];if(!u.startsWith("on")){if(["innerHTML","innerText","textContent"].includes(u)){m[0]=f;continue}if(u==="className"){h+=` class="${ct(...[f].flat())}"`;continue}u==="style"&&b(f)&&(f=JSON.stringify(f).slice(1,-1).replace(/"/g,"").replace(/,/g,";")),h+=` ${u}="${f}"`}}return`<${l}${h}>${r(m)}</${l}>`}function r(a){let l="";return y(a,p=>{l+=o(p)}),l}function c(a){return s==null||s(a),o(J(a))}return o(n)}let q;function Ht(){const n={};function t(u,f){n[u]=f}const e={};function s(u,f){e[u]=f}const o={state:new Rt({update:c}),memo:new Nt,effect:new st,callback:new vt,layoutEffect:new st,ref:new St,expose:new $t,context:new It,reducer:new it({update:c}),store:new Ut},i=Object.values(o),r=new WeakMap;function c(u){const f=r.get(u)||[];f.push(1),r.set(u,f);const d=C(f);_(()=>{C(f)===d&&(a.updateComp(u),r.delete(u))})}const a=new jt({intercept(u){if(!k(u))return;const{tag:f}=u;if(R(f)){const d=n[f];d&&(u.tag=d)}},currentCompTree(u){q=h,y(i,f=>{f.setInstance(u)})},compTreeReplace(u,f){y(i,d=>{d.fixInstance(u,f)})},created(u,f){o.effect.run(u)},mount(u,f,d){o.layoutEffect.run(u)},unmount(u,f){o.effect.runClear(u),o.layoutEffect.runClear(u),o.store.remove(u),y(i,d=>{d.removeInstance(u)})},nodeMount(u,f){const{ref:d,...g}=u.attrs;d&&(d.current=f),l(g,f)},nodeUpdate(u,f,d){_(()=>{const{ref:g,...M}=u.attrs;l(M,d)})}});function l(u,f){for(const d in u){const g=e[d];g&&g(u[d],f)}}function p(u){return a.render(u)}let m;const h={useComponent:t,useDirective:s,convert:p,render(u,f){m=u;const d=p(u);return f&&f.append(...d),d},unmount(){a.destroyComp(m)},renderToString(u){return Pt(u,{intercept(f){if(!k(f))return;const{tag:d,attrs:g}=f;if(R(d)){const M=n[d];if(M)return f.tag=M;for(const I in g)e[I]&&delete g[I]}},currentCompTree(f){y(i,d=>{d.setInstance(f)})}})},use(u){return u.install(h),h},compUpdate(u){return c(u)},compResult(u){return a.treeMap.get(u)}};return Object.setPrototypeOf(h,o),q=h,h}function Q(){return q}function j(){return Q()}const z=n=>j().state.use(n),T=(n,t)=>j().memo.use(n,t),at=(n,t)=>j().effect.use(n,t),Bt=(n,t)=>j().layoutEffect.use(n,t),Vt=n=>j().ref.use(n),Jt=(n,t,e)=>j().expose.use(n,t,e),Qt=n=>j().store.use(n);function Wt(n){const t={};return n.replace(/([^?&=]+)=([^&]+)/g,(e,s,o)=>t[s]=o),t}function At(n){return Object.keys(n).map(t=>`${t}=${n[t]}`).join("&")}function ut(n){const t=new URL("http://0.0.0.0"+n);return{fullPath:t.href.replace(t.origin,""),path:t.pathname,query:Wt(t.search),hash:t.hash.slice(1)}}function ft(n){let t="";const{path:e,query:s,hash:o}=n;return e&&(t+=e),C(Object.keys(s))>0&&(t+=`?${At(s)}`),o&&(t+=`#${o}`),t}const w={base:"",mode:"history",ssrDataKey:"g_initialProps"};let A;function Dt(n){A=ut(n)}function lt(){const{origin:n,href:t,hash:e}=location;return w.mode==="history"?t.replace(n+w.base,""):e.slice(1)}function zt(n){Object.assign(w,n),B()&&Dt(lt())}function pt(n,t){for(const e of n){const{path:s,exact:o}=e;if(bt(s)&&s.test(t)||R(s)&&(o===!1&&(t+"/").startsWith(s+"/")||t===s))return e}}class Ft{constructor(t){x(this,"option");x(this,"beforeEach");x(this,"currentRoute");t.prefix??(t.prefix="");const{beforeEach:e,fristUrl:s,...o}=t;this.beforeEach=e||((r,c,a)=>a()),this.option=o;const i=w.base;s.startsWith(i)&&this.change(s.replace(i,""))}change(t){return new Promise(e=>{const s=R(t)?t:ft(t),o=ut(s),{prefix:i,routes:r,controls:c}=this.option,a={...this.currentRoute};E(t,a)||this.beforeEach(o,a,()=>{this.currentRoute=o;const l=pt(r,o.fullPath.replace(i,""));function p(){c(l),e({to:o,from:a})}l&&l.beforeEach?l.beforeEach(o,a,()=>{p()}):p()})})}}const G=new Set;function ht(n){const t=new Ft(n);return G.add(t),t}const K=new Set;function Lt(n){return K.add(n),n(A,A),()=>{K.delete(n)}}async function ot(n,t){let e;for(const o of G.values())e=await o.change(n);if(E(e.to,e.from))return;A=e.to,K.forEach(o=>{o(e.to,e.from)});const s=e.to.fullPath;B()&&(w.mode==="history"?history[t+"State"](R(n)?{}:n.meta,null,w.base+s):location.hash=s)}function X(){return{push(n){ot(n,"push")},replace(n){ot(n,"replace")},go(n){history.go(n)},monitor:Lt,current:A}}let S={html:"",text:"",data:{},count:null,done(n){}};function dt(n){return T(()=>n.children.map(t=>t.attrs),[])}function mt(n,t){if(R(n))return n;const e=t.match(n);if(e)return e[0]}function Ot(n){n.prefix??(n.prefix="");const{prefix:t,loading:e,beforeEach:s}=n,o=dt(n),[i,r]=z(null);async function c(l,p){if(!l)return r(null);const{path:m,element:h,meta:u}=l,f=mt(m,p),d={path:t+f,meta:u},g={tag:h,attrs:d};H(h)&&(g.tag=(await h).default);const{getInitialProps:M}=h;if(U(M)){const I=window[w.ssrDataKey];b(I)&&I.hasOwnProperty(f)?(d.data=I[f],r(g),delete I[f]):(e&&r(e),M().then(Y=>{g.attrs.data=Y,r(g)}))}else r(g)}const a=T(()=>{const l=w.base+X().current.path;return ht({fristUrl:l,prefix:t,routes:o,beforeEach:s,controls(p){c(p,l)}})},[]);return at(()=>{function l(p){const m=lt().replace(t,""),h=pt(o,m);c(h,m)}return window.addEventListener("popstate",l),()=>{G.delete(a),window.removeEventListener("popstate",l)}},[]),L(V,{},i)}function _t(n){n.prefix??(n.prefix="");const{prefix:t,beforeEach:e}=n,s=dt(n),o=Q(),[i]=z("r_"+Et());function r(c){_(()=>{S.text=S.text.replace(i,o.renderToString(c)),S.count--})}return T(()=>{S.count??(S.count=0),S.count++;const c=w.base+X().current.path;return ht({fristUrl:c,prefix:t,routes:s,beforeEach:e,async controls(a){if(!a)return r("");const{path:l,element:p,meta:m}=a,h=mt(l,c),u={path:t+h,meta:m},f={tag:p,attrs:u};H(p)&&(f.tag=(await p).default);const{getInitialProps:d}=f.tag;U(d)?d().then(g=>{S.data[h]=g,u.data=g,r(f)}):r(f)}})},[]),L(V,{},i)}function Tt(n){return L(B()?Ot:_t,n)}function Gt(n){}function Xt(n){const{to:t,type:e,children:s,onClick:o,className:i,...r}=n;b(t)&&(n.to=ft(t));const[c,a]=z([]),l=X();at(()=>l.monitor(m=>{const h=n.to+"/",u=m.path+"/";a([u.startsWith(h)?"active":"",u===h?"exact-active":"",...[i].flat()])}),[]);function p(m){m.preventDefault();function h(u=n.to){l[e==="replace"?"replace":"push"](u)}o?o(t,h):h()}return L("a",{...r,className:c,href:w.base+n.to,onclick:p},...s)}export{V as F,Xt as L,Tt as R,at as a,T as b,Vt as c,Jt as d,y as e,Bt as f,Q as g,L as h,Kt as i,Qt as j,Gt as k,X as l,zt as m,_ as n,Ht as o,z as u};
