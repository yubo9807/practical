var xt=Object.defineProperty;var bt=(e,t,n)=>t in e?xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var x=(e,t,n)=>(bt(e,typeof t!="symbol"?t+"":t,n),n);function w(e){return e.length}function kt(e){throw new Error(e)}function B(e){return Promise.resolve().then(e)}function M(e,t,n=0){for(;n<w(e);)t(e[n],n),n++}function E(e){return typeof e=="string"}function C(e){return typeof e=="object"&&e!==null}function Et(e){return Array.isArray(e)}function j(e){return typeof e=="function"}function wt(e){return e.toString().slice(0,5)==="class"}function F(e){return typeof e=="object"&&e[Symbol.toStringTag]==="Promise"}function Ct(e){return e instanceof RegExp}function U(e,t){const n=new WeakSet;function s(r,c){if(C(r)&&C(c)){if(n.has(r)||n.has(c))return!0;n.add(r),n.add(c);const o=Object.keys(r),i=Object.keys(c);if(w(o)!==w(i))return!1;for(const u of o)if(!i.includes(u)||!s(r[u],c[u]))return!1;return!0}else return r===c}return s(e,t)}function L(e){return[null,void 0,!1].includes(e)}function Q(){return typeof window=="object"}function Rt(){return Number((Math.random()+"").slice(2)).toString(32)}function ot(e,t,n){if(typeof t=="string"&&(t=t.split(".")),t.length>1){const s=t.shift();e[s]=e[s]||{},ot(e[s],t,n)}else e[t[0]]=n}function _(e,t={},...n){t||(t={});const s={tag:e,attrs:t,children:(t.children||n).filter(r=>!L(r))};return O(e)&&!w(s.children)&&s.children.push(""),s}function T(){}function O(e){return e===T}function k(e){return C(e)&&C(e.attrs)}function I(e){return!O(e.tag)&&j(e.tag)}function z(e){const{tag:t,attrs:n,children:s}=e,r={...n,children:s};let c=t;if(wt(t)){const i=new t(r);c=i.render.bind(i)}let o=c(r);return I(o)?z(o):o}var v;(function(e){e.create="create",e.update="update",e.remove="remove"})(v||(v={}));function Z(e,t){const n=[],s=o=>Object.keys(o),r=s(e),c=s(t);for(const o of r){let p=function(m,d,a=""){if(k(m)&&k(d)){if(I(m)&&U(m,d))return ot(e,a,d),!0;a+=".children",M(m.children,(f,h)=>{const g=d.children[h];p(f,g,`${a}.${h}`)})}else return U(m,d)};const i=e[o],u=t[o],l={key:o,newValue:i,oldValue:u};if(!c.includes(o)){n.push({type:v.create,...l});continue}p(i,u,o)||n.push({type:v.update,...l})}for(const o of c)r.includes(o)||n.push({type:v.remove,key:o,newValue:e[o],oldValue:t[o]});return n}function ct(...e){const t=[];return M(e,n=>{j(n)&&(n=n()),L(n)||t.push(n)}),t.join(" ").trim().replace(/\s+/," ")}function tt(e,t){M(t,(n,s)=>{const r=e[s];r?n.replaceWith(r):n.remove()}),M(e,(n,s)=>{e[s-1].after(n)},w(t))}function Nt(e,t){t.after(...e)}function H(e){M(e,t=>{t.remove()})}function et(e,t,n){if(t==="style"&&C(n)){for(const s in n)e[t][s]=n[s];return}t==="className"&&Et(n)&&(n=ct(...n)),e[t]=n}const St=new Map;function nt(e){for(const t of St.values()){const n=t.get(e.attrs.key||e.tag);if(n)return n}}class R{constructor(){x(this,"instance");x(this,"count");x(this,"dataMap",new WeakMap)}setInstance(t){this.count=0,this.instance=t}fixInstance(t,n){const s=this.dataMap.get(n);s&&(this.dataMap.set(t,s),this.dataMap.delete(n))}removeInstance(t){this.dataMap.delete(t)}}function N(e){e||kt("Please set the instance first")}function it(e,t){return Object.is(e,t)}function K(e,t){if([e,t].includes(void 0))return!1;for(const n in e)if(!Object.is(e[n],t[n]))return!1;return!0}class vt extends R{constructor(n){super();x(this,"option");this.option=n}use(n){const{instance:s,dataMap:r,count:c,option:o}=this;N(s);const i=r.get(s)||new Map;let u;i.has(c)||i.set(c,j(n)?n():n),u=i.get(c);const l=p=>{const m=i.get(c);p=j(p)?p(m):p,!it(p,m)&&(i.set(c,p),o.update(s))};return r.set(s,i),this.count++,[u,l]}}class $t extends R{use(t,n){const{instance:s,dataMap:r,count:c}=this;N(s);const o=r.get(s)||new Map,i=o.get(c);if(i&&K(n,i.deps))return this.count++,i.result;const u=t();return o.set(c,{result:u,deps:n}),r.set(s,o),this.count++,u}}class jt extends R{use(t,n){const{instance:s,dataMap:r,count:c}=this;N(s);const o=r.get(s)||new Map,i=o.get(c);return K(n,i.deps)?i.func:(o.set(c,{func:t,deps:n}),this.count++,t)}}class st extends R{use(t,n){const{instance:s,dataMap:r,count:c}=this;N(s);const o=r.get(s)||new Map,i=o.get(c);o.set(c,{func:t,deps:n,oldDeps:i==null?void 0:i.oldDeps,clear:i==null?void 0:i.clear}),r.set(s,o),this.count++}run(t){const n=this.dataMap.get(t);n&&n.forEach(async s=>{const{clear:r,func:c,deps:o,oldDeps:i}=s;if(o!==void 0&&K(o,i))return;r&&r();const u=c();s.clear=F(u)?await u:u,s.oldDeps=o})}runClear(t){const n=this.dataMap.get(t);n&&n.forEach(s=>{s.clear&&s.clear()})}}class Ut extends R{use(t){const{instance:n,dataMap:s,count:r}=this;N(n);const c=s.get(n)||new Map;let o=c.get(r);return o||(o={current:t},c.set(r,o),s.set(n,c)),this.count++,o}}class It extends R{use(t,n,s){const{instance:r,dataMap:c,count:o}=this;if(N(r),!t)return;const i=c.get(r)||new Map,u=i.get(o);if(!u||!K(u.deps,s)){const l=n();t.current=l,i.set(o,{expose:l,deps:s}),c.set(r,i)}else t.current=u.expose;this.count++}}class Ot extends R{constructor(){super();x(this,"ctx");const n=this.fixInstance;this.fixInstance=(s,r)=>{this.ctx&&this.ctx.replace(s,r),n.call(this,s,r)}}use(n){const{instance:s}=this;return N(s),this.ctx=n,n.append(s),n.inject()}}class at extends R{constructor(n){super();x(this,"option");this.option=n}use(n,s,r){const{instance:c,dataMap:o,count:i,option:u}=this;N(c);const l=o.get(c)||new Map;if(l.has(i)){const m=l.get(i);return this.count++,[m.state,m.dispatch]}s=r?r(s):s;function p(m){let d=n(s,m);function a(f){return it(s,f)||(s=f,l.set(i,{state:s,dispatch:p}),u.update(c)),s}return F(d)?d.then(f=>a(f)):a(d)}return l.set(i,{state:s,dispatch:p}),o.set(c,l),this.count++,[s,p]}}const D=new Map;function Jt(e,t,n){const s={id:Math.random()};function r(){D.get(s).forEach(o=>{G().compUpdate(o)})}const c=new at({update:r});return c.setInstance(s),{reducer:c,handle:e,state:t,init:n,key:s}}class Pt extends R{use(t){const{instance:n}=this;N(n);const{reducer:s,handle:r,state:c,init:o,key:i}=t,u=D.get(i);u?u.add(n):D.set(i,new Set([n])),s.count=0;const[l,p]=s.use(r,c,o);return{state:l,dispatch:p}}remove(t){D.forEach(n=>{n.delete(t)})}}class Wt{constructor(t={}){x(this,"option");x(this,"fragmentMap",new Map);x(this,"treeMap",new WeakMap);this.option=t}render(t){const{intercept:n}=this.option;if(n==null||n(t),!C(t))return[document.createTextNode(t)];const{tag:s}=t;return E(s)?[this.toReals(t)]:O(s)?this.toFragment(t):this.createComp(t)}toReals(t){const{nodeMount:n}=this.option,{tag:s,attrs:r,children:c}=t,o=document.createElement(s);for(const i in r)et(o,i,r[i]);return M(c,i=>{const u=this.render(i);o.append(...u)}),n==null||n(t,o),o}toFragment(t){const n=[];return M(t.children,s=>{const r=this.render(s);n.push(...r)}),this.fragmentMap.set(t,n),n}replaceTreeMap(t,n){var r,c;(c=(r=this.option).compTreeReplace)==null||c.call(r,t,n);const s=this.treeMap.get(n);this.treeMap.set(t,s),this.treeMap.delete(n)}compTreeExec(t){const{currentCompTree:n,created:s}=this.option;n==null||n(t);const r=z(t);return s==null||s(t,r),r}createComp(t){var c,o;const n=nt(t);if(n)return this.treeMap.set(t,n),n.nodes;const s=this.compTreeExec(t),r=this.render(s);return this.treeMap.set(t,{tree:s,nodes:r}),(o=(c=this.option).mount)==null||o.call(c,t,s,r),r}destroyComp(t,n=!0){var s,r;if(k(t))if(I(t)){const c=nt(t),o=this.treeMap.get(t),{tree:i,nodes:u}=o;if(c){n&&H(u);return}this.destroyComp(i),(r=(s=this.option).unmount)==null||r.call(s,t,u),n&&H(u),this.treeMap.delete(t)}else M(t.children,c=>{this.destroyComp(c)})}updateComp(t){const n=this.treeMap.get(t);if(!n)return;const s=this.compTreeExec(t);this.updateTree(s,n.tree,n.nodes),n.tree=s;const{mount:r}=this.option;return r&&r(t,s,n.nodes),s}updateTree(t,n,s){const r=this;if(k(t)&&k(n)){if(t.tag!==n.tag){r.destroyComp(n,!1);const o=r.render(t);return tt(o,s),o}if(O(t.tag)){const o=r.fragmentMap.get(n)||s,i=[];return M(t.children,(u,l)=>{const p=n.children[l],m=o[l];if(U(u,p)){i.push(m);return}let d=[];if(L(p)){d=r.render(u);const a=i[l-1];Nt(d,a)}else{const a=r.updateTree(u,p,[m]);d.push(...a)}i.push(...d)}),M(o,u=>{u.remove()},w(t.children)),r.fragmentMap.set(t,i),r.fragmentMap.delete(n),i}if(E(t.tag)){const o=s[0],{nodeUpdate:i}=r.option;i&&i(t,n,o);const u=Z(t.attrs,n.attrs);M(u,m=>{const{type:d,key:a}=m;let f=m.newValue;d===v.remove?o.removeAttribute(a==="className"?"class":a):et(o,a,f)});const l=Z(t.children,n.children),p=[];return M(l,m=>{const{type:d,key:a,newValue:f,oldValue:h}=m,g=o.childNodes[a];if(d===v.remove)k(h)&&I(h)?r.destroyComp(h):p.push(g);else if(d===v.create){const y=r.render(f);o.append(...y)}else{let y=[g];k(h)&&(I(h)?y=r.treeMap.get(h).nodes:O(h.tag)&&(y=o.childNodes)),r.updateTree(f,h,y)}}),M(p,m=>m.remove()),s}if(I(t)){r.replaceTreeMap(t,n);const o=r.treeMap.get(t),i=r.compTreeExec(t),u=r.updateTree(i,o.tree,s);o.tree=i;const{mount:l}=this.option;return l&&l(t,i,u),u}}if(t||r.destroyComp(n,!1),L(t))return H(s),[];const c=r.render(t);return tt(c,s),c}}function At(e,t={}){const{intercept:n,currentCompTree:s}=t;function r(u){if(n==null||n(u),!k(u))return u;const{tag:l}=u;return E(l)?c(u):O(l)?o(u.children):i(u)}function c(u){const{tag:l,attrs:p,children:m}=u;let d="";for(const a in p){let f=p[a];if(!a.startsWith("on")){if(["innerHTML","innerText","textContent"].includes(a)){m[0]=f;continue}if(a==="className"){d+=` class="${ct(...[f].flat())}"`;continue}a==="style"&&C(f)&&(f=JSON.stringify(f).slice(1,-1).replace(/"/g,"").replace(/,/g,";")),d+=` ${a}="${f}"`}}return`<${l}${d}>${o(m)}</${l}>`}function o(u){let l="";return M(u,p=>{l+=r(p)}),l}function i(u){return s==null||s(u),r(z(u))}return r(e)}let V;function Qt(){const e={};function t(a,f){e[a]=f}const n={};function s(a,f){n[a]=f}const r={state:new vt({update:i}),memo:new $t,effect:new st,callback:new jt,layoutEffect:new st,ref:new Ut,expose:new It,context:new Ot,reducer:new at({update:i}),store:new Pt},c=Object.values(r),o=new WeakMap;function i(a){const f=o.get(a)||[];f.push(1),o.set(a,f);const h=w(f);B(()=>{w(f)===h&&(u.updateComp(a),o.delete(a))})}const u=new Wt({intercept(a){if(!k(a))return;const{tag:f}=a;if(E(f)){const h=e[f];h&&(a.tag=h)}},currentCompTree(a){V=d,M(c,f=>{f.setInstance(a)})},compTreeReplace(a,f){M(c,h=>{h.fixInstance(a,f)})},created(a,f){r.effect.run(a)},mount(a,f,h){r.layoutEffect.run(a)},unmount(a,f){r.effect.runClear(a),r.layoutEffect.runClear(a),r.store.remove(a),M(c,h=>{h.removeInstance(a)})},nodeMount(a,f){const{ref:h,...g}=a.attrs;h&&(h.current=f),l(g,f)},nodeUpdate(a,f,h){B(()=>{const{ref:g,...y}=a.attrs;l(y,h)})}});function l(a,f){for(const h in a){const g=n[h];g&&g(a[h],f)}}function p(a){return u.render(a)}let m;const d={useComponent:t,useDirective:s,convert:p,render(a,f){m=a;const h=p(a);return f&&f.append(...h),h},unmount(){u.destroyComp(m)},renderToString(a){return At(a,{intercept(f){if(!k(f))return;const{tag:h,attrs:g}=f;if(E(h)){const y=e[h];if(y)return f.tag=y;for(const W in g)n[W]&&delete g[W]}},currentCompTree(f){M(c,h=>{h.setInstance(f)})}})},use(a){return a.install(d),d},compUpdate(a){return i(a)},compResult(a){return u.treeMap.get(a)}};return Object.setPrototypeOf(d,r),V=d,d}function G(){return V}function $(){return G()}const ut=e=>$().state.use(e),q=(e,t)=>$().memo.use(e,t),ft=(e,t)=>$().effect.use(e,t),Tt=(e,t)=>$().layoutEffect.use(e,t),zt=e=>$().ref.use(e),Gt=(e,t,n)=>$().expose.use(e,t,n),Xt=(e,t,n)=>$().reducer.use(e,t,n),Yt=e=>$().store.use(e);function Dt(e){const t={};return e.replace(/([^?&=]+)=([^&]+)/g,(n,s,r)=>t[s]=r),t}function Ft(e){return Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}function lt(e){const t=new URL("http://0.0.0.0"+e);return{fullPath:t.href.replace(t.origin,""),path:t.pathname,query:Dt(t.search),hash:t.hash.slice(1)}}function pt(e){let t="";const{path:n,query:s,hash:r}=e;return n&&(t+=n),w(Object.keys(s))>0&&(t+=`?${Ft(s)}`),r&&(t+=`#${r}`),t}const b={base:"",mode:"history",ssrDataKey:"g_initialProps"};let P;function Lt(e){P=lt(e)}function ht(){const{origin:e,href:t,hash:n}=location;return b.mode==="history"?t.replace(e+b.base,""):n.slice(1)}function Zt(e){Object.assign(b,e),Q()&&Lt(ht())}function qt(e,t){for(const n of e){const{path:s,exact:r}=n;if(Ct(s)&&s.test(t)||E(s)&&(r===!1&&(t+"/").startsWith(s+"/")||t===s))return n}}class _t{constructor(t){x(this,"option");x(this,"beforeEach");x(this,"currentRoute");t.prefix??(t.prefix="");const{beforeEach:n,fristUrl:s,...r}=t;this.beforeEach=n||((o,i,u)=>u()),this.option=r;const c=b.base;s.startsWith(c)&&this.change(s.replace(c,""))}change(t){return new Promise(n=>{const s=E(t)?t:pt(t),r=lt(s),{prefix:c,routes:o,controls:i}=this.option,u={...this.currentRoute};U(t,u)||this.beforeEach(r,u,()=>{this.currentRoute=r;const l=qt(o,r.path.replace(c,""));function p(){i(l),n({to:r,from:u})}l&&l.beforeEach?l.beforeEach(r,u,()=>{p()}):p()})})}}const X=new Set;function dt(e){const t=new _t(e);return X.add(t),t}const J=new Set;function Kt(e){return J.add(e),e(P,P),()=>{J.delete(e)}}async function rt(e,t){E(e)||(e.path??(e.path=P.path));let n;for(const o of X.values())n=await o.change(e);if(U(n.to,n.from)||(P=n.to,J.forEach(o=>{o(n.to,n.from)}),!Q()))return;const{fullPath:s}=n.to,r=b.mode==="history"?s:"#"+s,c=E(e)?{}:e.meta;history[t+"State"](c,null,b.base+r)}function Y(){return{push(e){rt(e,"push")},replace(e){rt(e,"replace")},go(e){history.go(e)},monitor:Kt,current:P}}let S={html:"",text:"",data:{},count:null,done(e){}};function mt(e){return q(()=>e.children.map(t=>t.attrs),[])}function gt(e,t){if(E(e))return e;const n=t.match(e);if(n)return n[0]}async function yt(e){if(j(e)&&!e.prototype){const t=e();if(F(t))return(await t).default}return F(e)?(await e).default:e}function Ht(e){e.prefix??(e.prefix="");const{prefix:t,loading:n,beforeEach:s}=e,r=mt(e),[c,o]=ut(null);async function i(p,m){if(!p)return o(null);const{path:d,element:a,meta:f}=p,h=gt(d,m),g={path:t+h,meta:f},y={tag:a,attrs:g};y.tag=await yt(a);const{getInitialProps:W}=a;if(j(W)){const A=window[b.ssrDataKey];C(A)&&A.hasOwnProperty(h)?(g.data=A[h],o(y),delete A[h]):(n&&o(n),W().then(Mt=>{y.attrs.data=Mt,!U(c,y)&&o(y)}))}else{if(U(c,y))return;o(y)}}const u=Y(),l=q(()=>{const p=b.base+u.current.path;return dt({fristUrl:p,prefix:t,routes:r,beforeEach:s,controls(m){i(m,p)}})},[]);return l.option.controls=p=>{i(p,u.current.path)},ft(()=>{function p(m){const d=ht().replace(t,"");u.replace(d)}return window.addEventListener("popstate",p),()=>{X.delete(l),window.removeEventListener("popstate",p)}},[]),_(T,{},c)}function Bt(e){e.prefix??(e.prefix="");const{prefix:t,beforeEach:n}=e,s=mt(e),r=G(),c=q(()=>"r_"+Rt());function o(i){B(()=>{S.text=S.text.replace(c,r.renderToString(i)),S.count--})}return q(()=>{S.count??(S.count=0),S.count++;const i=b.base+Y().current.path;return dt({fristUrl:i,prefix:t,routes:s,beforeEach:n,async controls(u){if(!u)return o("");const{path:l,element:p,meta:m}=u,d=gt(l,i),a={path:t+d,meta:m},f={tag:p,attrs:a};f.tag=await yt(p);const{getInitialProps:h}=f.tag;j(h)?h().then(g=>{S.data[d]=g,a.data=g,o(f)}):o(f)}})},[]),_(T,{},c)}function te(e){return _(Q()?Ht:Bt,e)}function ee(e){}function ne(e){const{to:t,type:n,children:s,onClick:r,className:c,...o}=e;C(t)&&(e.to=pt(t));const[i,u]=ut([]),l=Y();ft(()=>l.monitor(d=>{const a=e.to+"/",f=d.path+"/";u([f.startsWith(a)?"active":"",f===a?"exact-active":"",...[c].flat()])}),[]);function p(d){d.preventDefault();function a(f=e.to){l[n==="replace"?"replace":"push"](f)}r?r(t,a):a()}const m=b.mode==="history"?e.to:"#"+e.to;return _("a",{...o,className:i,href:b.base+m,onclick:p},...s)}export{T as F,ne as L,te as R,ft as a,q as b,zt as c,Gt as d,M as e,Tt as f,G as g,_ as h,Jt as i,Yt as j,ee as k,Y as l,Zt as m,B as n,Qt as o,Xt as p,ut as u};
