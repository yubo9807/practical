var xt=Object.defineProperty;var bt=(e,t,n)=>t in e?xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var x=(e,t,n)=>(bt(e,typeof t!="symbol"?t+"":t,n),n);function w(e){return e.length}function kt(e){throw new Error(e)}function B(e){return Promise.resolve().then(e)}function M(e,t,n=0){for(;n<w(e);)t(e[n],n),n++}function E(e){return typeof e=="string"}function C(e){return typeof e=="object"&&e!==null}function Et(e){return Array.isArray(e)}function j(e){return typeof e=="function"}function wt(e){return e.toString().slice(0,5)==="class"}function F(e){return typeof e=="object"&&e[Symbol.toStringTag]==="Promise"}function Ct(e){return e instanceof RegExp}function U(e,t){const n=new WeakSet;function s(r,i){if(C(r)&&C(i)){if(n.has(r)||n.has(i))return!0;n.add(r),n.add(i);const o=Object.keys(r),c=Object.keys(i);if(w(o)!==w(c))return!1;for(const a of o)if(!c.includes(a)||!s(r[a],i[a]))return!1;return!0}else return r===i}return s(e,t)}function L(e){return[null,void 0,!1].includes(e)}function Q(){return typeof window=="object"}function Rt(){return Number((Math.random()+"").slice(2)).toString(32)}function ot(e,t,n){if(typeof t=="string"&&(t=t.split(".")),t.length>1){const s=t.shift();e[s]=e[s]||{},ot(e[s],t,n)}else e[t[0]]=n}function _(e,t={},...n){t||(t={});const s={tag:e,attrs:t,children:(t.children||n).filter(r=>!L(r))};return O(e)&&!w(s.children)&&s.children.push(""),s}function T(){}function O(e){return e===T}function k(e){return C(e)&&C(e.attrs)}function I(e){return!O(e.tag)&&j(e.tag)}function z(e){const{tag:t,attrs:n,children:s}=e,r={...n,children:s};let i=t;if(wt(t)){const c=new t(r);i=c.render.bind(c)}let o=i(r);return I(o)?z(o):o}var v;(function(e){e.create="create",e.update="update",e.remove="remove"})(v||(v={}));function Z(e,t){const n=[],s=o=>Object.keys(o),r=s(e),i=s(t);for(const o of r){let p=function(m,h,u=""){if(k(m)&&k(h)){if(I(m)&&U(m,h))return ot(e,u,h),!0;u+=".children",M(m.children,(f,d)=>{const g=h.children[d];p(f,g,`${u}.${d}`)})}else return U(m,h)};const c=e[o],a=t[o],l={key:o,newValue:c,oldValue:a};if(!i.includes(o)){n.push({type:v.create,...l});continue}p(c,a,o)||n.push({type:v.update,...l})}for(const o of i)r.includes(o)||n.push({type:v.remove,key:o,newValue:e[o],oldValue:t[o]});return n}function ct(...e){const t=[];return M(e,n=>{j(n)&&(n=n()),L(n)||t.push(n)}),t.join(" ").trim().replace(/\s+/," ")}function tt(e,t){M(t,(n,s)=>{const r=e[s];r?n.replaceWith(r):n.remove()}),M(e,(n,s)=>{e[s-1].after(n)},w(t))}function Nt(e,t){t.after(...e)}function H(e){M(e,t=>{t.remove()})}function et(e,t,n){if(t==="style"&&C(n)){for(const s in n)e[t][s]=n[s];return}t==="className"&&Et(n)&&(n=ct(...n)),e[t]=n}const St=new Map;function nt(e){for(const t of St.values()){const n=t.get(e.attrs.key||e.tag);if(n)return n}}class R{constructor(){x(this,"instance");x(this,"count");x(this,"dataMap",new WeakMap)}setInstance(t){this.count=0,this.instance=t}fixInstance(t,n){const s=this.dataMap.get(n);s&&(this.dataMap.set(t,s),this.dataMap.delete(n))}removeInstance(t){this.dataMap.delete(t)}}function N(e){e||kt("Please set the instance first")}function it(e,t){return Object.is(e,t)}function K(e,t){if([e,t].includes(void 0))return!1;for(const n in e)if(!Object.is(e[n],t[n]))return!1;return!0}class vt extends R{constructor(n){super();x(this,"option");this.option=n}use(n){const{instance:s,dataMap:r,count:i,option:o}=this;N(s);const c=r.get(s)||new Map;let a;c.has(i)||c.set(i,j(n)?n():n),a=c.get(i);const l=p=>{const m=c.get(i);p=j(p)?p(m):p,!it(p,m)&&(c.set(i,p),o.update(s))};return r.set(s,c),this.count++,[a,l]}}class $t extends R{use(t,n){const{instance:s,dataMap:r,count:i}=this;N(s);const o=r.get(s)||new Map,c=o.get(i);if(c&&K(n,c.deps))return this.count++,c.result;const a=t();return o.set(i,{result:a,deps:n}),r.set(s,o),this.count++,a}}class jt extends R{use(t,n){const{instance:s,dataMap:r,count:i}=this;N(s);const o=r.get(s)||new Map,c=o.get(i);return K(n,c.deps)?c.func:(o.set(i,{func:t,deps:n}),this.count++,t)}}class st extends R{use(t,n){const{instance:s,dataMap:r,count:i}=this;N(s);const o=r.get(s)||new Map,c=o.get(i);o.set(i,{func:t,deps:n,oldDeps:c==null?void 0:c.oldDeps,clear:c==null?void 0:c.clear}),r.set(s,o),this.count++}run(t){const n=this.dataMap.get(t);n&&n.forEach(async s=>{const{clear:r,func:i,deps:o,oldDeps:c}=s;if(o!==void 0&&K(o,c))return;r&&r();const a=i();s.clear=F(a)?await a:a,s.oldDeps=o})}runClear(t){const n=this.dataMap.get(t);n&&n.forEach(s=>{s.clear&&s.clear()})}}class Ut extends R{use(t){const{instance:n,dataMap:s,count:r}=this;N(n);const i=s.get(n)||new Map;let o=i.get(r);return o||(o={current:t},i.set(r,o),s.set(n,i)),this.count++,o}}class It extends R{use(t,n,s){const{instance:r,dataMap:i,count:o}=this;if(N(r),!t)return;const c=i.get(r)||new Map,a=c.get(o);if(!a||!K(a.deps,s)){const l=n();t.current=l,c.set(o,{expose:l,deps:s}),i.set(r,c)}else t.current=a.expose;this.count++}}class Ot extends R{constructor(){super();x(this,"ctx");const n=this.fixInstance;this.fixInstance=(s,r)=>{this.ctx&&this.ctx.replace(s,r),n.call(this,s,r)}}use(n){const{instance:s}=this;return N(s),this.ctx=n,n.append(s),n.inject()}}class at extends R{constructor(n){super();x(this,"option");this.option=n}use(n,s,r){const{instance:i,dataMap:o,count:c,option:a}=this;N(i);const l=o.get(i)||new Map;if(l.has(c)){const m=l.get(c);return this.count++,[m.state,m.dispatch]}s=r?r(s):s;function p(m){let h=n(s,m);function u(f){return it(s,f)||(s=f,l.set(c,{state:s,dispatch:p}),a.update(i)),s}return F(h)?h.then(f=>u(f)):u(h)}return l.set(c,{state:s,dispatch:p}),o.set(i,l),this.count++,[s,p]}}const D=new Map;function Jt(e,t,n){const s={id:Math.random()};let r;function i(a){r=a}function o(){D.get(s).forEach(a=>{r.compUpdate(a)})}const c=new at({update:o});return c.setInstance(s),{reducer:c,handle:e,state:t,init:n,key:s,bind:i}}class Pt extends R{use(t){const{instance:n}=this;N(n);const{reducer:s,handle:r,state:i,init:o,key:c,bind:a}=t;a(G());const l=D.get(c);l?l.add(n):D.set(c,new Set([n])),s.count=0;const[p,m]=s.use(r,i,o);return{state:p,dispatch:m}}remove(t){D.forEach(n=>{n.delete(t)})}}class Wt{constructor(t={}){x(this,"option");x(this,"fragmentMap",new Map);x(this,"treeMap",new WeakMap);this.option=t}render(t){const{intercept:n}=this.option;if(n==null||n(t),!C(t))return[document.createTextNode(t)];const{tag:s}=t;return E(s)?[this.toReals(t)]:O(s)?this.toFragment(t):this.createComp(t)}toReals(t){const{nodeMount:n}=this.option,{tag:s,attrs:r,children:i}=t,o=document.createElement(s);for(const c in r)et(o,c,r[c]);return M(i,c=>{const a=this.render(c);o.append(...a)}),n==null||n(t,o),o}toFragment(t){const n=[];return M(t.children,s=>{const r=this.render(s);n.push(...r)}),this.fragmentMap.set(t,n),n}replaceTreeMap(t,n){var r,i;(i=(r=this.option).compTreeReplace)==null||i.call(r,t,n);const s=this.treeMap.get(n);this.treeMap.set(t,s),this.treeMap.delete(n)}compTreeExec(t){const{currentCompTree:n,created:s}=this.option;n==null||n(t);const r=z(t);return s==null||s(t,r),r}createComp(t){var i,o;const n=nt(t);if(n)return this.treeMap.set(t,n),n.nodes;const s=this.compTreeExec(t),r=this.render(s);return this.treeMap.set(t,{tree:s,nodes:r}),(o=(i=this.option).mount)==null||o.call(i,t,s,r),r}destroyComp(t,n=!0){var s,r;if(k(t))if(I(t)){const i=nt(t),o=this.treeMap.get(t),{tree:c,nodes:a}=o;if(i){n&&H(a);return}this.destroyComp(c),(r=(s=this.option).unmount)==null||r.call(s,t,a),n&&H(a),this.treeMap.delete(t)}else M(t.children,i=>{this.destroyComp(i)})}updateComp(t){const n=this.treeMap.get(t);if(!n)return;const s=this.compTreeExec(t);this.updateTree(s,n.tree,n.nodes),n.tree=s;const{mount:r}=this.option;return r&&r(t,s,n.nodes),s}updateTree(t,n,s){const r=this;if(k(t)&&k(n)){if(t.tag!==n.tag){r.destroyComp(n,!1);const o=r.render(t);return tt(o,s),o}if(O(t.tag)){const o=r.fragmentMap.get(n)||s,c=[];return M(t.children,(a,l)=>{const p=n.children[l],m=o[l];if(U(a,p)){c.push(m);return}let h=[];if(L(p)){h=r.render(a);const u=c[l-1];Nt(h,u)}else{const u=r.updateTree(a,p,[m]);h.push(...u)}c.push(...h)}),M(o,a=>{a.remove()},w(t.children)),r.fragmentMap.set(t,c),r.fragmentMap.delete(n),c}if(E(t.tag)){const o=s[0],{nodeUpdate:c}=r.option;c&&c(t,n,o);const a=Z(t.attrs,n.attrs);M(a,m=>{const{type:h,key:u}=m;let f=m.newValue;h===v.remove?o.removeAttribute(u==="className"?"class":u):et(o,u,f)});const l=Z(t.children,n.children),p=[];return M(l,m=>{const{type:h,key:u,newValue:f,oldValue:d}=m,g=o.childNodes[u];if(h===v.remove)k(d)&&I(d)?r.destroyComp(d):p.push(g);else if(h===v.create){const y=r.render(f);o.append(...y)}else{let y=[g];k(d)&&(I(d)?y=r.treeMap.get(d).nodes:O(d.tag)&&(y=o.childNodes)),r.updateTree(f,d,y)}}),M(p,m=>m.remove()),s}if(I(t)){r.replaceTreeMap(t,n);const o=r.treeMap.get(t),c=r.compTreeExec(t),a=r.updateTree(c,o.tree,s);o.tree=c;const{mount:l}=this.option;return l&&l(t,c,a),a}}if(t||r.destroyComp(n,!1),L(t))return H(s),[];const i=r.render(t);return tt(i,s),i}}function At(e,t={}){const{intercept:n,currentCompTree:s}=t;function r(a){if(n==null||n(a),!k(a))return a;const{tag:l}=a;return E(l)?i(a):O(l)?o(a.children):c(a)}function i(a){const{tag:l,attrs:p,children:m}=a;let h="";for(const u in p){let f=p[u];if(!u.startsWith("on")){if(["innerHTML","innerText","textContent"].includes(u)){m[0]=f;continue}if(u==="className"){h+=` class="${ct(...[f].flat())}"`;continue}u==="style"&&C(f)&&(f=JSON.stringify(f).slice(1,-1).replace(/"/g,"").replace(/,/g,";")),h+=` ${u}="${f}"`}}return`<${l}${h}>${o(m)}</${l}>`}function o(a){let l="";return M(a,p=>{l+=r(p)}),l}function c(a){return s==null||s(a),r(z(a))}return r(e)}let V;function Qt(){const e={};function t(u,f){e[u]=f}const n={};function s(u,f){n[u]=f}const r={state:new vt({update:c}),memo:new $t,effect:new st,callback:new jt,layoutEffect:new st,ref:new Ut,expose:new It,context:new Ot,reducer:new at({update:c}),store:new Pt},i=Object.values(r),o=new WeakMap;function c(u){const f=o.get(u)||[];f.push(1),o.set(u,f);const d=w(f);B(()=>{w(f)===d&&(a.updateComp(u),o.delete(u))})}const a=new Wt({intercept(u){if(!k(u))return;const{tag:f}=u;if(E(f)){const d=e[f];d&&(u.tag=d)}},currentCompTree(u){V=h,M(i,f=>{f.setInstance(u)})},compTreeReplace(u,f){M(i,d=>{d.fixInstance(u,f)})},created(u,f){r.effect.run(u)},mount(u,f,d){r.layoutEffect.run(u)},unmount(u,f){r.effect.runClear(u),r.layoutEffect.runClear(u),r.store.remove(u),M(i,d=>{d.removeInstance(u)})},nodeMount(u,f){const{ref:d,...g}=u.attrs;d&&(d.current=f),l(g,f)},nodeUpdate(u,f,d){B(()=>{const{ref:g,...y}=u.attrs;l(y,d)})}});function l(u,f){for(const d in u){const g=n[d];g&&g(u[d],f)}}function p(u){return a.render(u)}let m;const h={useComponent:t,useDirective:s,convert:p,render(u,f){m=u;const d=p(u);return f&&f.append(...d),d},unmount(){a.destroyComp(m)},renderToString(u){return At(u,{intercept(f){if(!k(f))return;const{tag:d,attrs:g}=f;if(E(d)){const y=e[d];if(y)return f.tag=y;for(const W in g)n[W]&&delete g[W]}},currentCompTree(f){M(i,d=>{d.setInstance(f)})}})},use(u){return u.install(h),h},compUpdate(u){return c(u)},compResult(u){return a.treeMap.get(u)},version:"0.0.10"};return Object.setPrototypeOf(h,r),V=h,h}function G(){return V}const $=G,ut=e=>$().state.use(e),q=(e,t)=>$().memo.use(e,t),ft=(e,t)=>$().effect.use(e,t),Tt=(e,t)=>$().layoutEffect.use(e,t),zt=e=>$().ref.use(e),Gt=(e,t,n)=>$().expose.use(e,t,n),Xt=(e,t,n)=>$().reducer.use(e,t,n),Yt=e=>$().store.use(e);function Dt(e){const t={};return e.replace(/([^?&=]+)=([^&]+)/g,(n,s,r)=>t[s]=r),t}function Ft(e){return Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}function lt(e){const t=new URL("http://0.0.0.0"+e);return{fullPath:t.href.replace(t.origin,""),path:t.pathname,query:Dt(t.search),hash:t.hash.slice(1)}}function pt(e){let t="";const{path:n,query:s,hash:r}=e;return n&&(t+=n),w(Object.keys(s))>0&&(t+=`?${Ft(s)}`),r&&(t+=`#${r}`),t}const b={base:"",mode:"history",ssrDataKey:"g_initialProps"};let P;function Lt(e){P=lt(e)}function dt(){const{origin:e,href:t,hash:n}=location;return b.mode==="history"?t.replace(e+b.base,""):n.slice(1)}function Zt(e){Object.assign(b,e),Q()&&Lt(dt())}function qt(e,t){for(const n of e){const{path:s,exact:r}=n;if(Ct(s)&&s.test(t)||E(s)&&(r===!1&&(t+"/").startsWith(s+"/")||t===s))return n}}class _t{constructor(t){x(this,"option");x(this,"beforeEach");x(this,"currentRoute");t.prefix??(t.prefix="");const{beforeEach:n,fristUrl:s,...r}=t;this.beforeEach=n||((o,c,a)=>a()),this.option=r;const i=b.base;s.startsWith(i)&&this.change(s.replace(i,""))}change(t){return new Promise(n=>{const s=E(t)?t:pt(t),r=lt(s),{prefix:i,routes:o,controls:c}=this.option,a={...this.currentRoute};U(t,a)||this.beforeEach(r,a,()=>{this.currentRoute=r;const l=qt(o,r.path.replace(i,""));function p(){c(l),n({to:r,from:a})}l&&l.beforeEach?l.beforeEach(r,a,()=>{p()}):p()})})}}const X=new Set;function ht(e){const t=new _t(e);return X.add(t),t}const J=new Set;function Kt(e){return J.add(e),e(P,P),()=>{J.delete(e)}}async function rt(e,t){E(e)||(e.path??(e.path=P.path));let n;for(const o of X.values())n=await o.change(e);if(U(n.to,n.from)||(P=n.to,J.forEach(o=>{o(n.to,n.from)}),!Q()))return;const{fullPath:s}=n.to,r=b.mode==="history"?s:"#"+s,i=E(e)?{}:e.meta;history[t+"State"](i,null,b.base+r)}function Y(){return{push(e){rt(e,"push")},replace(e){rt(e,"replace")},go(e){history.go(e)},monitor:Kt,current:P}}let S={html:"",text:"",data:{},count:null,done(e){}};function mt(e){return q(()=>e.children.map(t=>t.attrs),[])}function gt(e,t){if(E(e))return e;const n=t.match(e);if(n)return n[0]}async function yt(e){if(j(e)&&!e.prototype){const t=e();if(F(t))return(await t).default}return F(e)?(await e).default:e}function Ht(e){e.prefix??(e.prefix="");const{prefix:t,loading:n,beforeEach:s}=e,r=mt(e),[i,o]=ut(null);async function c(p,m){if(!p)return o(null);const{path:h,element:u,meta:f}=p,d=gt(h,m),g={path:t+d,meta:f},y={tag:u,attrs:g};y.tag=await yt(u);const{getInitialProps:W}=y.tag;if(j(W)){const A=window[b.ssrDataKey];C(A)&&A.hasOwnProperty(d)?(g.data=A[d],o(y),delete A[d]):(n&&o(n),W().then(Mt=>{y.attrs.data=Mt,!U(i,y)&&o(y)}))}else{if(U(i,y))return;o(y)}}const a=Y(),l=q(()=>{const p=b.base+a.current.path;return ht({fristUrl:p,prefix:t,routes:r,beforeEach:s,controls(m){c(m,p)}})},[]);return l.option.controls=p=>{c(p,a.current.path)},ft(()=>{function p(m){const h=dt().replace(t,"");a.replace(h)}return window.addEventListener("popstate",p),()=>{X.delete(l),window.removeEventListener("popstate",p)}},[]),_(T,{},i)}function Bt(e){e.prefix??(e.prefix="");const{prefix:t,beforeEach:n}=e,s=mt(e),r=G(),i=q(()=>"r_"+Rt());function o(c){B(()=>{S.text=S.text.replace(i,r.renderToString(c)),S.count--})}return q(()=>{S.count??(S.count=0),S.count++;const c=b.base+Y().current.path;return ht({fristUrl:c,prefix:t,routes:s,beforeEach:n,async controls(a){if(!a)return o("");const{path:l,element:p,meta:m}=a,h=gt(l,c),u={path:t+h,meta:m},f={tag:p,attrs:u};f.tag=await yt(p);const{getInitialProps:d}=f.tag;j(d)?d().then(g=>{S.data[h]=g,u.data=g,o(f)}):o(f)}})},[]),_(T,{},i)}function te(e){return _(Q()?Ht:Bt,e)}function ee(e){}function ne(e){const{to:t,type:n,children:s,onClick:r,className:i,...o}=e;C(t)&&(e.to=pt(t));const[c,a]=ut([]),l=Y();ft(()=>l.monitor(h=>{const u=e.to+"/",f=h.path+"/";a([f.startsWith(u)?"active":"",f===u?"exact-active":"",...[i].flat()])}),[]);function p(h){h.preventDefault();function u(f=e.to){l[n==="replace"?"replace":"push"](f)}r?r(t,u):u()}const m=b.mode==="history"?e.to:"#"+e.to;return _("a",{...o,className:c,href:b.base+m,onclick:p},...s)}export{T as F,ne as L,te as R,ft as a,q as b,zt as c,Gt as d,M as e,Tt as f,G as g,_ as h,Jt as i,Yt as j,ee as k,Y as l,Zt as m,B as n,Qt as o,Xt as p,ut as u};
